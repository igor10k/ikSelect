// ikSelect 0.9.5
// Copyright (c) 2012 Igor Kozlov
// i10k.ru
(function(e,t,n,r){function f(t,n){var r=this,i={};r.element=t;r._defaults=s;if(typeof t=="undefined")return r;r.select=e(t);for(var o in s)i[o]=r.select.data(o.toLowerCase());r.options=e.extend({},s,n,i);r.fakeSelect=e('<div class="ik_select">'+r.options.syntax+"</div>");r.link=e(".ik_select_link",r.fakeSelect);r.linkText=e(".ik_select_link_text",r.fakeSelect);r.block=e(".ik_select_block",r.fakeSelect);r.list=e(".ik_select_list",r.fakeSelect);r.listInner=e('<div class="ik_select_list_inner"/>');r.filter=e([]);r.listItemsOriginal=e([]);r.nothingFoundText=e('<div class="ik_nothing_found"/>').html(r.options.nothingFoundText);if(r.options.filter&&!e.browser.mobile){r.filterWrap=e(".ik_select_filter_wrap",r.fakeSelect);r.filterWrap.length||(r.filterWrap=e('<div class="ik_select_filter_wrap"/>'));r.filter=e('<input type="text" class="ik_select_filter">');r.filterWrap.append(r.filter)}r.active=e([]);r.hover=e([]);r.hoverIndex=-1;r.listItems=e([]);r.listOptgroupItems=e([]);r.init()}var i=e(t),s={syntax:'<div class="ik_select_link"><span class="ik_select_link_text"></span></div><div class="ik_select_block"><div class="ik_select_list"></div></div>',autoWidth:!0,ddFullWidth:!0,equalWidths:!0,customClass:"",ddCustomClass:"",ddMaxHeight:200,filter:!1,nothingFoundText:"Nothing found",onShow:function(){},onHide:function(){},onKeyUp:function(){},onKeyDown:function(){},onHoverMove:function(){}},o=e([]),u=!1,a=-1;e.browser=e.browser||{};e.browser.webkit=e.browser.webkit||/webkit/i.test(navigator.userAgent.toLowerCase());e.browser.mobile=/iphone|ipad|ipod|android/i.test(navigator.userAgent.toLowerCase());e.browser.operamini=Object.prototype.toString.call(t.operamini)==="[object OperaMini]";e.extend(f.prototype,{init:function(){var t=this,n=t.fakeSelect,r=t.select,s=t.link,u=t.block,a=t.list,f=t.listInner,l=s.hasClass("ik_select_link_disabled"),c=t.filter,h="",p,d;a.append(f);n.addClass(t.options.customClass);u.addClass(t.options.ddCustomClass);t.reset_all();r.attr("disabled")&&t.disable_select();s.bind("click.ikSelect",function(){if(l)return;if(o.length&&o.is(r)){o.data("plugin_ikSelect").hide_block();return}t.show_block();t.options.filter&&!e.browser.mobile?c.focus():r.focus()});r.bind("focus.ikSelect",function(){if(l)return this;s.addClass("ik_select_link_focus");(n.offset().top+n.height()>i.scrollTop()+i.height()||n.offset().top+n.height()<i.scrollTop())&&i.scrollTop(n.offset().top-i.height()/2)});f.on("scroll",function(){clearTimeout(d);d=setTimeout(function(){r.focus()},70)});r.bind("blur.ikSelect",function(){if(l)return this;s.removeClass("ik_select_link_focus")});r.bind("change.ikSelect",function(){t._select_fake_option()});c.bind("keyup.ikSelect",function(){var n=c.val();f.show();if(typeof p=="undefined"){t.listItemsOriginal=t.listItems;p=e.makeArray(e(".ik_select_option",t.listItems).map(function(t,n){return e(n).text().toLowerCase()}))}if(n!==h){if(n===""){t.listItems=t.listItemsOriginal.show();t.listOptgroupItems.show();t.nothingFoundText.remove()}else{t.listItems=e([]);t.listOptgroupItems.show();t.listItemsOriginal.each(function(r){if(p[r].indexOf(n)>=0){t.listItems=t.listItems.add(this);e(this).show()}else e(this).hide()});if(t.listItems.length){t.nothingFoundText.remove();t.listOptgroupItems.each(function(){var t=e(this);e("> ul > li:visible",t).length||t.hide()});!t.listItems.filter(t.hover).length&&t.listItems.length&&t._move_to(t.listItems.eq(0));t.hoverIndex=t.listItems.index(t.hover)}else{f.hide();a.append(t.nothingFoundText)}}h=n}});r.add(c).bind("keydown.ikSelect keyup.ikSelect",function(n){var i=e(this),o=t.listItems,a=n.which,l=n.type,h,p,d;if(t.hoverIndex<0||t.hoverIndex>=o.length)t.hoverIndex=o.index(t.hover);switch(a){case 40:if(l==="keydown"){n.preventDefault();if(t.hoverIndex<o.length-1){p=o.eq(++t.hoverIndex);while(p&&p.hasClass("ik_select_option_disabled"))p=o.filter(":eq("+ ++t.hoverIndex+")")}p&&t._move_to(p)}break;case 38:if(l==="keydown"){n.preventDefault();if(t.hoverIndex>0){h=o.eq(--t.hoverIndex);while(h&&h.hasClass("ik_select_option_disabled"))h=o.filter(":eq("+ --t.hoverIndex+")")}h&&t._move_to(h)}break;case 33:if(l==="keydown"){n.preventDefault();d=t.hover.position().top-f.height();h=o.eq(--t.hoverIndex);while(h.length&&h.position().top>d)h=o.eq(--t.hoverIndex);h.length?t._move_to(h):t._move_to(o.filter(":not(.ik_select_option_disabled):first"))}break;case 36:if(i.is(c))return;if(l==="keydown"){n.preventDefault();t._move_to(o.filter(":not(.ik_select_option_disabled):first"))}break;case 34:if(l==="keydown"){n.preventDefault();d=t.hover.position().top+f.height();p=o.eq(++t.hoverIndex);while(p.length&&p.position().top<d)p=o.eq(++t.hoverIndex);p.length?t._move_to(p):t._move_to(o.filter(":not(.ik_select_option_disabled):last"))}break;case 35:if(i.is(c))return;if(l==="keydown"){n.preventDefault();t._move_to(o.filter(":not(.ik_select_option_disabled):last"))}break;case 32:if(l==="keydown"&&e(this).is(r)){n.preventDefault();u.is(":visible")?t._select_real_option():s.click()}break;case 13:if(l==="keydown"&&u.is(":visible")){n.preventDefault();t._select_real_option()}break;case 27:if(l==="keydown"){n.preventDefault();t.hide_block()}break;case 9:l==="keydown"&&(e.browser.webkit&&u.is(":visible")?n.preventDefault():t.hide_block());break;default:l==="keyup"&&e(this).is(r)&&t._select_fake_option()}if(l==="keydown"){t.options.onKeyDown(t,a);r.trigger("ikkeydown",[t,a])}if(l==="keyup"){t.options.onKeyUp(t,a);r.trigger("ikkeyup",[t,a])}});r.after(n);t.options.filter&&!e.browser.mobile&&a.prepend(t.filterWrap);t.redraw();r.appendTo(n)},redraw:function(){var t=this,n=t.select,r=t.fakeSelect,i=t.link,s=t.block,o=t.list,u=t.listInner,f=t.filter,l=t.options.autoWidth,c=t.options.ddFullWidth,h,p,d,v,m,g,y,b,w;t.options.filter&&!e.browser.mobile&&f.hide();if(l||c){u.width("auto");e("ul:first",u).width("auto");r.width("auto");s.show().width(9999);u.css("float","left");o.css("position","absolute");h=o.outerWidth(!0);p=o.width();o.css("position","static");s.css("width","100%");u.css("float","none");if(a===-1){d=e('<div style="width:50px; height:50px; overflow:hidden; position:absolute; top:-200px; left:-200px;"><div style="height:100px;"></div>');e("body").append(d);v=e("div",d).innerWidth();d.css("overflow","auto");m=e("div",d).innerWidth();e(d).remove();a=v-m}g=r.parent().width();if(c){s.width(h);u.width(p);e("ul:first",u).width(p)}h>g&&(h=g);if(l){y=t.listItems.first();b=parseInt(y.css("paddingLeft"),10)+parseInt(y.css("paddingRight"),10);w=i.outerWidth(!0)-i.width();r.width(w>b?h-b+w:h).addClass("ik_select_autowidth")}}t.options.filter&&!e.browser.mobile&&f.show().outerWidth(t.filterWrap.width());s.hide();t._fix_height();n.css({position:"absolute",margin:0,padding:0,left:-9999,top:0});e.browser.mobile&&n.css({opacity:0,left:0,height:r.height(),width:r.width()});e("> ul",u).css("position","relative")},reset_all:function(){var t=this,n=t.select,r=t.linkText,i=t.listInner,s="";r.html(n.val());i.empty();s="<ul>";n.children().each(function(){var t,n;if(this.tagName==="OPTGROUP"){t=e(this);s+='<li class="ik_select_optgroup'+(t.is(":disabled")?" ik_select_optgroup_disabled":"")+'">';s+='<div class="ik_select_optgroup_label">'+t.attr("label")+"</div>";s+="<ul>";e("option",t).each(function(){n=e(this);s+="<li"+(n.is(":disabled")?' class="ik_select_option_disabled"':"")+'><span class="ik_select_option'+(n[0].getAttribute("value")?"":" ik_select_option_novalue")+'" data-title="'+n.val()+'">'+n.html()+"</span></li>"});s+="</ul>";s+="</li>"}else{n=e(this);s+="<li"+(n.is(":disabled")?' class="ik_select_option_disabled"':"")+'><span class="ik_select_option'+(n[0].getAttribute("value")?"":" ik_select_option_novalue")+'" data-title="'+n.val()+'">'+n.html()+"</span></li>"}});s+="</ul>";i.append(s);t._select_fake_option();t.listOptgroupItems=e(".ik_select_optgroup",i);t.listItems=e("li:not(.ik_select_optgroup)",i);t._attach_list_events(t.listItems)},_attach_list_events:function(t){var n=this,r=n.select,i=n.link,s=n.linkText,o=t.not(".ik_select_option_disabled");o.bind("click.ikSelect",function(){var t=e(".ik_select_option",this);s.html(t.html());r.val(t.data("title"));n.active.removeClass("ik_select_active");n.active=e(this).addClass("ik_select_active");n.hide_block();t.hasClass("ik_select_option_novalue")?i.addClass("ik_select_link_novalue"):i.removeClass("ik_select_link_novalue");r.change();r.focus()});o.bind("mouseover.ikSelect",function(){n.hoverIndex=-1;n.hover.removeClass("ik_select_hover");n.hover=e(this).addClass("ik_select_hover")});o.addClass("ik_select_has_events")},_detach_list_events:function(e){e.unbind(".ikSelect").removeClass("ik_select_has_events")},set_defaults:function(t){e.extend(this._defaults,t||{});return this},hide_block:function(){var t=this,n=t.fakeSelect,r=t.block,i=t.select;t.options.filter&&!e.browser.mobile&&t.filter.val("").keyup();if(t.listItemsOriginal.length){t.listOptgroupItems.show();t.listItems=t.listItemsOriginal.show()}r.hide().appendTo(n).css({left:"",top:""});i.removeClass(".ik_select_opened").focus();o=e([]);t.options.onHide(t);i.trigger("ikhide",[t])},show_block:function(){var t=this,n=t.select,r=t.fakeSelect,s=t.block,u=t.list,a=t.listInner,f=t.hover,l=t.active,c=t.listItems,h,p,d,v,m,g,y,b,w,E,S;if(o.is(t.select)||!t.listItems.length)return;o.length&&o.data("plugin_ikSelect").hide_block();s.show();n.addClass("ik_select_opened");h=e("option",n).index(e("option:selected",n));f.removeClass("ik_select_hover");l.removeClass("ik_select_active");p=c.eq(h).addClass("ik_select_hover ik_select_active");t.hover=p;t.active=p;t.hoverIndex=t.listItems.index(p);d=s.offset();v=s.outerWidth(!0);m=s.outerHeight(!0);g=i.width(),y=i.height(),b=i.scrollTop(),s.css("left","");t.options.ddFullWidth&&r.offset().left+v>g&&s.css("left",(d.left+v-g)*-1);s.css("top","");d.top+m>b+y&&s.css("top",(d.top+m-parseInt(s.css("top"),10)-(b+y))*-1);w=d.left;w<0&&(w=0);E=d.top;s.width(s.width());s.appendTo("body").css({left:w,top:E});S=t.active.position().top-u.height()/2;u.data("ik_select_scrollTop",S);a.scrollTop(S);o=n;t.options.onShow(t);n.trigger("ikshow",[t])},add_options:function(t){var n=this,r=n.select,i=n.listInner,s="",o="";e.each(t,function(t,n){var u,a,f;if(typeof n=="string"){s+='<li><span class="ik_select_option" data-title="'+t+'">'+n+"</span></li>";o+='<option value="'+t+'">'+n+"</option>"}else if(typeof n=="object"){u=e("> ul > li.ik_select_optgroup:eq("+t+") > ul",i);a=e("optgroup:eq("+t+")",r);f=n;e.each(f,function(e,t){s+='<li><span class="ik_select_option" data-title="'+e+'">'+t+"</span></li>";o+='<option value="'+e+'">'+t+"</option>"});u.append(s);a.append(o);s="";o=""}});if(o!==""){e(":first",i).append(s);r.append(o)}n._fix_height();n.listItems=e("li:not(.ik_select_optgroup)",i);n._attach_list_events(n.listItems)},remove_options:function(t){var n=this,r=n.select,i=n.listItems,s=e([]);e.each(t,function(t,n){e("option",r).each(function(t){e(this).val()===n&&(s=s.add(e(this)).add(i.eq(t)))})});n.listItems=i.not(s);s.remove();n._select_fake_option();n._fix_height()},_select_real_option:function(){var e=this.hover,t=this.active;t.removeClass("ik_select_active");e.addClass("ik_select_active").click()},_select_fake_option:function(){var t=this,n=t.select,r=t.fakeSelect,i=t.link,s=t.linkText,o=t.listItems,u=e(":selected",n),a=e("option",n).index(u);s.html(u.html());u.length&&u[0].getAttribute("value")?i.removeClass("ik_select_link_novalue"):i.addClass("ik_select_link_novalue");t.hover=o.removeClass("ik_select_hover ik_select_active").eq(a).addClass("ik_select_hover ik_select_active");t.active=t.hover;e.browser.mobile&&n.css({height:r.height(),width:r.width()})},disable_select:function(){var e=this.select,t=this.link;e.attr("disabled","disabled");t.addClass("ik_select_link_disabled")},enable_select:function(){var e=this.select,t=this.link;e.removeAttr("disabled");t.removeClass("ik_select_link_disabled")},toggle_select:function(){var e=this,t=this.link;t.hasClass("ik_select_link_disabled")?e.enable_select():e.disable_select()},make_selection:function(e){var t=this,n=t.select;n.val(e);t._select_fake_option()},disable_optgroups:function(t){var n=this,r=n.select,i=n.list;e.each(t,function(t,s){var o=e("optgroup:eq("+s+")",r);o.attr("disabled","disabled");e(".ik_select_optgroup:eq("+s+")",i).addClass("ik_select_optgroup_disabled");n.disable_options(e("option",o))});n._select_fake_option()},enable_optgroups:function(t){var n=this,r=n.select,i=n.list;e.each(t,function(t,s){var o=e("optgroup:eq("+s+")",r).removeAttr("disabled");e(".ik_select_optgroup:eq("+s+")",i).removeClass("ik_select_optgroup_disabled");n.enable_options(e("option",o))});n._select_fake_option()},disable_options:function(t){var n=this,r=n.select,i=n.listItems,s=e("option",r);e.each(t,function(t,r){var o,u;if(typeof r=="object"){e(this).attr("disabled","disabled");o=s.index(this);u=i.eq(o).addClass("ik_select_option_disabled");n._detach_list_events(u)}else s.each(function(t){if(e(this).val()===r){e(this).attr("disabled","disabled");u=i.eq(t).addClass("ik_select_option_disabled");n._detach_list_events(u);return this}})});n._select_fake_option()},enable_options:function(t){var n=this,r=n.select,i=n.listItems,s=e("option",r);e.each(t,function(t,r){var o,u;if(typeof r=="object"){e(this).removeAttr("disabled");o=s.index(this);u=i.eq(o).removeClass("ik_select_option_disabled");n._attach_list_events(u)}else s.each(function(t){if(e(this).val()===r){e(this).removeAttr("disabled");u=i.eq(t).removeClass("ik_select_option_disabled");n._attach_list_events(u);return this}})});n._select_fake_option()},detach_plugin:function(){var e=this,t=e.select,n=e.fakeSelect;t.unbind(".ikSelect").css({width:"",height:"",left:"",top:"",position:"",margin:"",padding:""});n.before(t);n.remove()},_move_to:function(t){var n=this,r=n.select,i=n.linkText,s=n.block,o=n.list,u=n.listInner,a,f;if(!s.is(":visible")&&e.browser.webkit){n.show_block();return this}n.hover.removeClass("ik_select_hover");t.addClass("ik_select_hover");n.hover=t;if(!e.browser.webkit){n.active.removeClass("ik_select_active");t.addClass("ik_select_active");n.active=t}if(!s.is(":visible")||e.browser.mozilla){if(!e.browser.mozilla){r.val(e(".ik_select_option",t).data("title"));r.change()}i.html(e(".ik_select_option",t).html())}a=t.offset().top-o.offset().top-parseInt(o.css("paddingTop"),10);f=a+t.outerHeight();f>o.height()?u.scrollTop(u.scrollTop()+f-o.height()):a<0&&u.scrollTop(u.scrollTop()+a);n.options.onHoverMove(t,n);r.trigger("ikhovermove",[t,n])},_fix_height:function(){var t=this,n=t.block,r=t.listInner,i=t.options.ddMaxHeight,s=t.options.ddFullWidth;n.show();r.css("height","auto");if(r.height()>i){r.css({overflow:"auto",height:i,position:"relative"});if(!e.data(r,"ik_select_hasScrollbar")&&s){n.width(n.width()+a);r.width(r.width()+a)}e.data(r,"ik_select_hasScrollbar",!0)}else if(e.data(r,"ik_select_hasScrollbar")){r.css({overflow:"",height:"auto"});r.width(r.width()-a);n.width(n.width()-a)}n.hide()}});e.fn.ikSelect=function(t){var n,r;if(e.browser.operamini)return this;n=Array.prototype.slice.call(arguments);return this.each(function(){if(!e.data(this,"plugin_ikSelect"))e.data(this,"plugin_ikSelect",new f(this,t));else if(typeof t=="string"){r=e.data(this,"plugin_ikSelect");switch(t){case"reset":r.reset_all();break;case"hide_dropdown":r.hide_block();break;case"show_dropdown":u=!0;r.select.focus();r.show_block();break;case"add_options":r.add_options(n[1]);break;case"remove_options":r.remove_options(n[1]);break;case"enable":r.enable_select();break;case"disable":r.disable_select();break;case"toggle":r.toggle_select();break;case"select":r.make_selection(n[1]);break;case"set_defaults":r.set_defaults(n[1]);break;case"redraw":r.redraw();break;case"disable_options":r.disable_options(n[1]);break;case"enable_options":r.enable_options(n[1]);break;case"disable_optgroups":r.disable_optgroups(n[1]);break;case"enable_optgroups":r.enable_optgroups(n[1]);break;case"detach":r.detach_plugin()}}})};e.ikSelect=new f;e(n).bind("click.ikSelect",function(t){if(!u&&o.length&&!e(t.target).closest(".ik_select").length&&!e(t.target).closest(".ik_select_block").length){o.ikSelect("hide_dropdown");o=e([])}u&&(u=!1)})})(jQuery,window,document);